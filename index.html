<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>MindAR – HTML Overlay UI</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    /* Reset cơ bản */
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    
    /* Scene AR */
    a-scene { width: 100%; height: 100%; position: absolute; inset: 0; z-index: 1; }

    /* Màn hình chờ */
    #scanning-overlay {
      position: absolute; inset: 0; z-index: 999;
      background: rgba(0, 0, 0, 0.85); color: #fff;
      display: flex; align-items: center; justify-content: center;
      text-align: center; padding: 20px;
      transition: opacity 0.5s;
    }
    .hidden { display: none !important; opacity: 0; pointer-events: none; }

    /* --- GIAO DIỆN UI (Mới) --- */
    #info-panel {
      position: fixed;
      bottom: 30px; left: 20px; right: 20px; /* Cách lề */
      z-index: 100; /* Nằm trên AR */
      
      /* Hiệu ứng nền kính mờ cho sang trọng */
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      
      border-left: 5px solid #FFD700; /* Viền vàng điểm nhấn */
      padding: 15px;
      border-radius: 8px;
      color: #fff;
      
      /* Mặc định ẩn, sẽ hiện bằng JS */
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }

    /* Khi kích hoạt class .visible */
    #info-panel.visible {
      opacity: 1;
      transform: translateY(0);
    }

    #ui-title {
      margin: 0 0 5px 0;
      font-size: 18px;
      font-weight: bold;
      color: #FFD700; /* Vàng kim */
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #ui-desc {
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
      color: #e0e0e0;
    }
  </style>
</head>

<body>
  <div id="scanning-overlay">Đang khởi động Camera…<br/>Vui lòng đợi!</div>

  <div id="info-panel">
    <div id="ui-title"></div>
    <div id="ui-desc"></div>
  </div>

  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta:0.001;"
    renderer="colorManagement: true, physicallyCorrectLights"
    color-space="sRGB"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded
  >
    <a-assets>
      <audio id="audio1" src="audio1.mp3" preload="auto"></audio>
      <audio id="audio2" src="audio2.mp3" preload="auto"></audio>
      <video id="video1" src="video1.mp4" preload="auto" loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      </a-entity>

    <a-entity mindar-image-target="targetIndex: 1">
      
      <a-entity
        reveal-model="duration: 3000; audio: #audio2;
                      startScale: 0.001 0.001 0.001; finalScale: 0.6 0.6 0.6;
                      startPos: 0 0.08 0; finalPos: 0 0.32 0"
        slow-spin
      >
        <a-entity
          id="model"
          gltf-model="url(model.glb)"
          rotation="90 0 0" 
          transparent-model="opacity: 0.6"
        ></a-entity>
      </a-entity>

      <a-entity 
        html-overlay-controller="
          delay: 3000;
          audio: #audio2;
          title: TÊN LỬA P-15 U;
          desc: Được sử dụng trong kháng chiến chống Mỹ cứu nước năm 1945, 1967. Được biên chế cho Trung tâm BĐKT năm 2008.
        "
      ></a-entity>

    </a-entity>

    <a-entity mindar-image-target="targetIndex: 2" video-on-target="video: #video1; restart: true">
      <a-video src="#video1" width="1.0" height="0.5625" position="0 0 0.001"></a-video>
    </a-entity>

  </a-scene>

  <script>
    // --- XỬ LÝ MÀN HÌNH CHỜ ---
    const sceneEl = document.querySelector("a-scene");
    const overlay = document.querySelector("#scanning-overlay");
    sceneEl.addEventListener("arReady", () => overlay.classList.add("hidden"));

    // --- HÀM PHÁT NHẠC CHUNG ---
    function playAudio(audioEl){
      if(!audioEl) return;
      try{
        audioEl.currentTime = 0;
        audioEl.play().catch(()=>{});
      }catch(e){}
    }

    /* =========================================================
       COMPONENT: HTML OVERLAY CONTROLLER
       (Kết nối giữa AR và giao diện HTML 2D)
       ========================================================= */
    AFRAME.registerComponent("html-overlay-controller", {
      schema: {
        delay: {type: "number", default: 3000},
        audio: {type: "selector"},
        title: {type: "string"},
        desc: {type: "string"}
      },
      init() {
        // Lấy các thẻ HTML bên ngoài Scene
        this.uiPanel = document.getElementById("info-panel");
        this.uiTitle = document.getElementById("ui-title");
        this.uiDesc = document.getElementById("ui-desc");
        
        this.target = this.el.closest("[mindar-image-target]");
        
        // Timer quản lý
        this.startTimer = null;
        this.typingTimer = null;

        // Bắt sự kiện
        this.target.addEventListener("targetFound", () => this.onFound());
        this.target.addEventListener("targetLost", () => this.onLost());
      },
      
      onFound() {
        // Reset nội dung cũ
        this.uiTitle.innerText = "";
        this.uiDesc.innerText = "";
        
        // Đợi delay (để model bay lên xong) mới hiện bảng
        this.startTimer = setTimeout(() => {
          this.showPanel();
        }, this.data.delay);
      },

      onLost() {
        // Hủy mọi thứ ngay lập tức
        if (this.startTimer) clearTimeout(this.startTimer);
        if (this.typingTimer) clearTimeout(this.typingTimer);
        
        // Ẩn bảng
        this.uiPanel.classList.remove("visible");
      },

      showPanel() {
        // 1. Hiện bảng (Fade in)
        this.uiPanel.classList.add("visible");
        
        // 2. Phát nhạc (nếu chưa phát ở đoạn reveal model)
        // playAudio(this.data.audio); // Bỏ comment nếu muốn phát lại nhạc lúc hiện chữ

        // 3. Hiệu ứng gõ chữ (Typewriter) trên HTML
        const fullTitle = this.data.title;
        const fullDesc = this.data.desc;
        
        let i = 0;
        
        const typeLoop = () => {
          // Logic: Chạy hết Title rồi mới chạy Desc
          if (i < fullTitle.length) {
            this.uiTitle.innerText += fullTitle.charAt(i);
            i++;
            this.typingTimer = setTimeout(typeLoop, 30); // Tốc độ title
          } else {
            // Đã xong title, chuyển sang desc
            const descIndex = i - fullTitle.length;
            if (descIndex < fullDesc.length) {
              this.uiDesc.innerText += fullDesc.charAt(descIndex);
              i++;
              this.typingTimer = setTimeout(typeLoop, 20); // Tốc độ desc nhanh hơn xíu
            }
          }
        };
        typeLoop();
      }
    });

    /* =========================================================
       CÁC COMPONENT CŨ CẦN THIẾT (MODEL, SPIN, VIDEO...)
       ========================================================= */
    AFRAME.registerComponent("reveal-model", {
      schema: {
        duration:{type:"number",default:3000},
        audio:{type:"selector"},
        startScale:{type:"vec3"}, finalScale:{type:"vec3"}, startPos:{type:"vec3"}, finalPos:{type:"vec3"}
      },
      init(){
        this.target = this.el.closest("[mindar-image-target]");
        this.running = false;
        this._hardReset();
        this.target.addEventListener("targetLost", ()=>this._hardReset());
        this.target.addEventListener("targetFound", ()=>this.start());
      },
      _hardReset(){
        this.running = false;
        this.el.removeAttribute("animation__scale");
        this.el.removeAttribute("animation__pos");
        const ss = this.data.startScale, sp = this.data.startPos;
        this.el.setAttribute("scale", `${ss.x} ${ss.y} ${ss.z}`);
        this.el.setAttribute("position", `${sp.x} ${sp.y} ${sp.z}`);
        if(this.el.object3D){
          this.el.object3D.scale.set(ss.x, ss.y, ss.z);
          this.el.object3D.position.set(sp.x, sp.y, sp.z);
        }
      },
      start(){
        if(this.running) return;
        this.running = true;
        this._hardReset();
        playAudio(this.data.audio); // Nhạc phát khi model bay lên
        const fs = this.data.finalScale, fp = this.data.finalPos;
        requestAnimationFrame(()=>requestAnimationFrame(()=>{
          this.el.setAttribute("animation__scale", { property:"scale", to:`${fs.x} ${fs.y} ${fs.z}`, dur:this.data.duration, easing:"easeOutCubic" });
          this.el.setAttribute("animation__pos", { property:"position", to:`${fp.x} ${fp.y} ${fp.z}`, dur:this.data.duration, easing:"easeOutCubic" });
        }));
      }
    });

    AFRAME.registerComponent("slow-spin", {
      init(){
        this.el.setAttribute("animation__spin", { property:"rotation", to:"0 0 360", loop:true, dur:14000, easing:"linear" });
      }
    });

    AFRAME.registerComponent("transparent-model", {
      schema:{ opacity:{type:"number",default:0.6} },
      init(){
        this.el.addEventListener("model-loaded", ()=>{
          const op = this.data.opacity;
          this.el.object3D.traverse(n=>{
            if(n.material){
              const mats = Array.isArray(n.material) ? n.material : [n.material];
              mats.forEach(m=>{
                m.transparent = true; m.opacity = op; m.depthWrite = true; m.side = THREE.FrontSide; m.needsUpdate = true;
              });
            }
          });
        });
      }
    });

    AFRAME.registerComponent("video-on-target", {
      schema: { video: { type: "selector" }, restart: { type: "boolean", default: true } },
      init(){
        this.target = this.el.closest("[mindar-image-target]");
        this.video = this.data.video;
        if(!this.video) return;
        this._stopHard();
        this._onFound = ()=>this.playHard();
        this._onLost  = ()=>this._stopHard();
        this.target.addEventListener("targetFound", this._onFound);
        this.target.addEventListener("targetLost", this._onLost);
      },
      _stopHard(){
        if(!this.video) return;
        try{ this.video.pause(); this.video.currentTime = 0; this.video.load(); }catch(e){}
      },
      playHard(){
        if(!this.video) return;
        const v = this.video;
        v.muted = true; v.setAttribute("playsinline", ""); v.setAttribute("webkit-playsinline", "");
        if(this.data.restart){ try { v.currentTime = 0; } catch(e){} }
        const tryPlay = ()=>{ try{ v.play().catch(()=>{}); }catch(e){} };
        if(v.readyState < 2){
          const onCanPlay = ()=>{ v.removeEventListener("canplay", onCanPlay); tryPlay(); };
          v.addEventListener("canplay", onCanPlay, { once: true });
          try { v.load(); } catch(e){}
        } else { tryPlay(); }
      }
    });
  </script>
</body>
</html>
