<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>MindAR – Fix Space Text</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    /* Reset & Font */
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    
    a-scene { width: 100%; height: 100%; position: absolute; inset: 0; z-index: 1; }

    /* Màn hình chờ */
    #scanning-overlay {
      position: absolute; inset: 0; z-index: 999;
      background: rgba(0, 0, 0, 0.85); color: #fff;
      display: flex; align-items: center; justify-content: center;
      text-align: center; padding: 20px;
      transition: opacity 0.5s;
    }
    .hidden { display: none !important; opacity: 0; pointer-events: none; }

    /* --- UI PANEL --- */
    #info-panel {
      position: fixed;
      bottom: 20px; left: 15px; right: 15px;
      z-index: 100;
      
      background: rgba(10, 10, 10, 0.8); /* Màu nền đậm hơn chút */
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      
      border-left: 4px solid #FFD700;
      padding: 15px;
      border-radius: 8px;
      color: #fff;
      
      /* Cấu hình hiển thị chữ */
      max-height: 40%;
      overflow-y: auto;
      word-wrap: break-word; /* Tự động xuống dòng */
      white-space: pre-wrap; /* QUAN TRỌNG: Giữ nguyên dấu cách và xuống dòng */
      
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }

    #info-panel.visible {
      opacity: 1;
      transform: translateY(0);
    }

    #ui-title {
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: 700;
      color: #FFD700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      line-height: 1.3;
    }

    #ui-desc {
      margin: 0;
      font-size: 15px; /* Chữ to hơn xíu cho dễ đọc */
      line-height: 1.6;
      color: #e0e0e0;
      text-align: left; /* Canh trái chuẩn để không bị lỗi giãn chữ */
    }
  </style>
</head>

<body>
  <div id="scanning-overlay">Đang khởi động Camera…<br/>Vui lòng đợi!</div>

  <div id="info-panel">
    <div id="ui-title"></div>
    <div id="ui-desc"></div>
  </div>

  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta:0.001;"
    renderer="colorManagement: true, physicallyCorrectLights"
    color-space="sRGB"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded
  >
    <a-assets>
      <audio id="audio1" src="audio1.mp3" preload="auto"></audio>
      <audio id="audio2" src="audio2.mp3" preload="auto"></audio>
      <video id="video1" src="video1.mp4" preload="auto" loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
       </a-entity>

    <a-entity mindar-image-target="targetIndex: 1">
      
      <a-entity
        reveal-model="duration: 3000; audio: #audio2;
                      startScale: 0.001 0.001 0.001; finalScale: 0.6 0.6 0.6;
                      startPos: 0 0.08 0; finalPos: 0 0.32 0"
        slow-spin
      >
        <a-entity
          id="model"
          gltf-model="url(model.glb)"
          rotation="90 0 0" 
          transparent-model="opacity: 0.6"
        ></a-entity>
      </a-entity>

      <a-entity 
        html-overlay-controller="delay: 3000; audio: #audio2"
        data-title="TÊN LỬA P-15 U"
        data-desc="Được sử dụng trong kháng chiến chống Mỹ cứu nước năm 1945, 1967. Được biên chế cho Trung tâm BĐKT năm 2008. Đây là đoạn văn bản dài có dấu cách đầy đủ để bạn kiểm tra."
      ></a-entity>

    </a-entity>

    <a-entity mindar-image-target="targetIndex: 2" video-on-target="video: #video1; restart: true">
      <a-video src="#video1" width="1.0" height="0.5625" position="0 0 0.001"></a-video>
    </a-entity>

  </a-scene>

  <script>
    const sceneEl = document.querySelector("a-scene");
    const overlay = document.querySelector("#scanning-overlay");
    sceneEl.addEventListener("arReady", () => overlay.classList.add("hidden"));

    function playAudio(audioEl){
      if(!audioEl) return;
      try{
        audioEl.currentTime = 0;
        audioEl.play().catch(()=>{});
      }catch(e){}
    }

    /* =========================================================
       HTML OVERLAY CONTROLLER (UPDATED)
       - Đọc dữ liệu từ data-title/data-desc thay vì schema
       ========================================================= */
    AFRAME.registerComponent("html-overlay-controller", {
      schema: {
        delay: {type: "number", default: 3000},
        audio: {type: "selector"}
        // Không khai báo title/desc ở đây nữa để tránh parser làm lỗi font
      },
      init() {
        this.uiPanel = document.getElementById("info-panel");
        this.uiTitle = document.getElementById("ui-title");
        this.uiDesc = document.getElementById("ui-desc");
        
        // Lấy text trực tiếp từ attribute HTML (an toàn nhất)
        this.fullTitle = this.el.getAttribute("data-title") || "";
        this.fullDesc = this.el.getAttribute("data-desc") || "";

        this.target = this.el.closest("[mindar-image-target]");
        this.startTimer = null;
        this.typingTimer = null;

        this.target.addEventListener("targetFound", () => this.onFound());
        this.target.addEventListener("targetLost", () => this.onLost());
      },
      
      onFound() {
        // Xóa nội dung cũ
        this.uiTitle.textContent = "";
        this.uiDesc.textContent = "";
        
        this.startTimer = setTimeout(() => { this.showPanel(); }, this.data.delay);
      },

      onLost() {
        if (this.startTimer) clearTimeout(this.startTimer);
        if (this.typingTimer) clearTimeout(this.typingTimer);
        this.uiPanel.classList.remove("visible");
      },

      showPanel() {
        this.uiPanel.classList.add("visible");
        
        let i = 0;
        const totalLen = this.fullTitle.length + this.fullDesc.length;
        
        const typeLoop = () => {
          // Chạy Title trước
          if (i < this.fullTitle.length) {
            this.uiTitle.textContent += this.fullTitle.charAt(i);
            i++;
            // Tốc độ title nhanh (30ms)
            this.typingTimer = setTimeout(typeLoop, 30);
          } 
          // Chạy Desc sau
          else {
            const descIndex = i - this.fullTitle.length;
            if (descIndex < this.fullDesc.length) {
              this.uiDesc.textContent += this.fullDesc.charAt(descIndex);
              i++;
              // Tốc độ desc nhanh hơn tí (20ms) cho mượt
              this.typingTimer = setTimeout(typeLoop, 20);
            }
          }
        };
        typeLoop();
      }
    });

    /* =========================================================
       CÁC COMPONENT KHÁC (GIỮ NGUYÊN)
       ========================================================= */
    AFRAME.registerComponent("reveal-model", {
      schema: {
        duration:{type:"number",default:3000},
        audio:{type:"selector"},
        startScale:{type:"vec3"}, finalScale:{type:"vec3"}, startPos:{type:"vec3"}, finalPos:{type:"vec3"}
      },
      init(){
        this.target = this.el.closest("[mindar-image-target]");
        this.running = false;
        this._hardReset();
        this.target.addEventListener("targetLost", ()=>this._hardReset());
        this.target.addEventListener("targetFound", ()=>this.start());
      },
      _hardReset(){
        this.running = false;
        this.el.removeAttribute("animation__scale");
        this.el.removeAttribute("animation__pos");
        const ss = this.data.startScale, sp = this.data.startPos;
        this.el.setAttribute("scale", `${ss.x} ${ss.y} ${ss.z}`);
        this.el.setAttribute("position", `${sp.x} ${sp.y} ${sp.z}`);
        if(this.el.object3D){
          this.el.object3D.scale.set(ss.x, ss.y, ss.z);
          this.el.object3D.position.set(sp.x, sp.y, sp.z);
        }
      },
      start(){
        if(this.running) return;
        this.running = true;
        this._hardReset();
        playAudio(this.data.audio);
        const fs = this.data.finalScale, fp = this.data.finalPos;
        requestAnimationFrame(()=>requestAnimationFrame(()=>{
          this.el.setAttribute("animation__scale", { property:"scale", to:`${fs.x} ${fs.y} ${fs.z}`, dur:this.data.duration, easing:"easeOutCubic" });
          this.el.setAttribute("animation__pos", { property:"position", to:`${fp.x} ${fp.y} ${fp.z}`, dur:this.data.duration, easing:"easeOutCubic" });
        }));
      }
    });

    AFRAME.registerComponent("slow-spin", {
      init(){
        this.el.setAttribute("animation__spin", { property:"rotation", to:"0 0 360", loop:true, dur:14000, easing:"linear" });
      }
    });

    AFRAME.registerComponent("transparent-model", {
      schema:{ opacity:{type:"number",default:0.6} },
      init(){
        this.el.addEventListener("model-loaded", ()=>{
          const op = this.data.opacity;
          this.el.object3D.traverse(n=>{
            if(n.material){
              const mats = Array.isArray(n.material) ? n.material : [n.material];
              mats.forEach(m=>{
                m.transparent = true; m.opacity = op; m.depthWrite = true; m.side = THREE.FrontSide; m.needsUpdate = true;
              });
            }
          });
        });
      }
    });

    AFRAME.registerComponent("video-on-target", {
      schema: { video: { type: "selector" }, restart: { type: "boolean", default: true } },
      init(){
        this.target = this.el.closest("[mindar-image-target]");
        this.video = this.data.video;
        if(!this.video) return;
        this._stopHard();
        this._onFound = ()=>this.playHard();
        this._onLost  = ()=>this._stopHard();
        this.target.addEventListener("targetFound", this._onFound);
        this.target.addEventListener("targetLost", this._onLost);
      },
      _stopHard(){
        if(!this.video) return;
        try{ this.video.pause(); this.video.currentTime = 0; this.video.load(); }catch(e){}
      },
      playHard(){
        if(!this.video) return;
        const v = this.video;
        v.muted = true; v.setAttribute("playsinline", ""); v.setAttribute("webkit-playsinline", "");
        if(this.data.restart){ try { v.currentTime = 0; } catch(e){} }
        const tryPlay = ()=>{ try{ v.play().catch(()=>{}); }catch(e){} };
        if(v.readyState < 2){
          const onCanPlay = ()=>{ v.removeEventListener("canplay", onCanPlay); tryPlay(); };
          v.addEventListener("canplay", onCanPlay, { once: true });
          try { v.load(); } catch(e){}
        } else { tryPlay(); }
      }
    });
  </script>
</body>
</html>
