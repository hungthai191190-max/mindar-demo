<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>MindAR Multi Target</title>

    <!-- A-Frame + MindAR -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      a-scene {
        width: 100%;
        height: 100%;
        position: absolute;
        inset: 0;
      }

      #scanning-overlay {
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        z-index: 999;
        font-family: sans-serif;
        text-align: center;
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <div id="scanning-overlay">
      Đang khởi động Camera...<br />Vui lòng đợi!
    </div>

    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta:0.001;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      embedded
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- ========= TARGET 0 : TEXT (KHÔNG CÓ NỀN MỜ) ========= -->
      <a-entity mindar-image-target="targetIndex: 0">
        <a-entity
          position="0 0.2 0"
          typewriter-spin="text: PHONG TRUYEN THONG\n1965"
        >
          <!-- Shadow -->
          <a-entity
            class="text-layer"
            text="value: ; align: center; width: 4.2; lineHeight: 58; letterSpacing: 1.2; color: #000; opacity: 0.6;"
            position="0.025 -0.025 -0.03"
          ></a-entity>

          <!-- Glow -->
          <a-entity
            class="text-layer"
            text="value: ; align: center; width: 4.2; lineHeight: 58; letterSpacing: 1.2; color: #00e5ff; opacity: 0.35;"
            position="0 0 -0.02"
          ></a-entity>

          <!-- Main -->
          <a-entity
            class="text-layer"
            text="value: ; align: center; width: 4.2; lineHeight: 58; letterSpacing: 1.2; color: #FFD700;"
            position="0 0 0"
          ></a-entity>
        </a-entity>
      </a-entity>

      <!-- ========= TARGET 1 : 3D MODEL ========= -->
      <a-entity mindar-image-target="targetIndex: 1">
        <a-entity
          gltf-model="url(model.glb)"
          position="0 0 0"
          scale="0.4 0.4 0.4"
          rotation="0 0 0"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 12000; easing: linear"
          transparent-model
        ></a-entity>
      </a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector("a-scene");
      const overlay = document.querySelector("#scanning-overlay");

      sceneEl.addEventListener("arReady", () => {
        overlay.classList.add("hidden");
      });

      /* ===== TYPEWRITER TEXT ===== */
      AFRAME.registerComponent("typewriter-spin", {
        schema: { text: { type: "string" } },
        init() {
          this.layers = this.el.querySelectorAll(".text-layer");
          this.fullText = this.data.text;
          this.index = 0;
          this.started = false;
        },
        tick() {
          if (this.started) return;
          this.started = true;

          this.el.setAttribute("scale", "0.001 0.001 0.001");
          this.el.setAttribute("animation__pop", {
            property: "scale",
            to: "1 1 1",
            dur: 700,
            easing: "easeOutElastic",
          });

          this.type();
        },
        type() {
          if (this.index <= this.fullText.length) {
            const t = this.fullText.slice(0, this.index);
            this.layers.forEach((l) =>
              l.setAttribute("text", "value", t)
            );
            this.index++;
            setTimeout(() => this.type(), 55);
          }
        },
      });

      /* ===== TRANSPARENT MODEL FIX ===== */
      AFRAME.registerComponent("transparent-model", {
        init() {
          this.el.addEventListener("model-loaded", () => {
            this.el.object3D.traverse((node) => {
              if (node.material) {
                node.material.transparent = true;
                node.material.opacity = 0.6; // chỉnh độ trong suốt
                node.material.depthWrite = false;
              }
            });
          });
        },
      });
    </script>
  </body>
</html>

