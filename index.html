<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>MindAR – Text + 3D + Video (3 Targets)</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <!-- Troika Text (hỗ trợ tiếng Việt có dấu) -->
  <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>

  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
    a-scene { width: 100%; height: 100%; position: absolute; inset: 0; }
    #scanning-overlay{
      position:absolute; inset:0; z-index:999;
      background:rgba(0,0,0,.85); color:#fff;
      display:flex; align-items:center; justify-content:center;
      text-align:center; font-family:sans-serif;
      padding: 20px;
    }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div id="scanning-overlay">Đang khởi động Camera…<br/>Vui lòng đợi!</div>

  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta:0.001;"
    renderer="colorManagement: true, physicallyCorrectLights"
    color-space="sRGB"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded
  >
    <a-assets>
      <audio id="audio1" src="audio1.mp3" preload="auto"></audio>
      <audio id="audio2" src="audio2.mp3" preload="auto"></audio>

      <!-- Video: muted + playsinline để autoplay trên mobile -->
      <video
        id="video1"
        src="video1.mp4"
        preload="auto"
        loop
        muted
        playsinline
        webkit-playsinline
        crossorigin="anonymous"
      ></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- =====================================================
         TARGET 0 – TEXT (3s typewriter + audio1)
         ===================================================== -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-entity
        position="0 0.2 0"
        reveal-typewriter="text: PHÒNG TRUYỀN THÔNG\nNĂM 1965; duration: 3000; audio: #audio1"
      >
        <!-- Shadow -->
        <a-troika-text
          class="tw"
          value=""
          color="#000000"
          opacity="0.55"
          fontSize="0.18"
          maxWidth="2.2"
          align="center"
          anchor="center"
          position="0.02 -0.02 -0.03"
        ></a-troika-text>

        <!-- Glow -->
        <a-troika-text
          class="tw"
          value=""
          color="#00E5FF"
          opacity="0.35"
          fontSize="0.18"
          maxWidth="2.2"
          align="center"
          anchor="center"
          position="0 0 -0.02"
        ></a-troika-text>

        <!-- Main -->
        <a-troika-text
          class="tw"
          value=""
          color="#FFD700"
          opacity="1"
          fontSize="0.18"
          maxWidth="2.2"
          align="center"
          anchor="center"
          position="0 0 0"
        ></a-troika-text>
      </a-entity>
    </a-entity>

    <!-- =====================================================
         TARGET 1 – 3D MODEL (small → big in 3s + audio2)
         ===================================================== -->
    <a-entity mindar-image-target="targetIndex: 1">
      <a-entity
        id="model"
        gltf-model="url(model.glb)"
        reveal-model="duration: 3000; audio: #audio2;
                      startScale: 0.001 0.001 0.001;
                      finalScale: 0.4 0.4 0.4;
                      startPos: 0 0.08 0;
                      finalPos: 0 0.32 0"
        slow-spin
        transparent-model="opacity: 0.6"
      ></a-entity>
    </a-entity>

    <!-- =====================================================
         TARGET 2 – VIDEO ON WALL (16:9) auto play/pause
         Ảnh target kích thước 1920x1080 nên tỉ lệ 16:9
         ===================================================== -->
    <a-entity mindar-image-target="targetIndex: 2" video-on-target="video: #video1">
      <a-video
        id="video-plane"
        src="#video1"
        width="1.0"
        height="0.5625"
        position="0 0 0.001"
        rotation="0 0 0"
      ></a-video>
    </a-entity>

  </a-scene>

  <script>
    const sceneEl = document.querySelector("a-scene");
    const overlay = document.querySelector("#scanning-overlay");
    sceneEl.addEventListener("arReady", () => overlay.classList.add("hidden"));

    function playAudio(audioEl){
      if(!audioEl) return;
      try{
        audioEl.currentTime = 0;
        const p = audioEl.play();
        if(p && p.catch) p.catch(()=>{});
      }catch(e){}
    }

    /* ================= TEXT: typewriter ================= */
    AFRAME.registerComponent("reveal-typewriter", {
      schema: { text:{type:"string"}, duration:{type:"number",default:3000}, audio:{type:"selector"} },
      init(){
        this.layers = this.el.querySelectorAll(".tw");
        this.target = this.el.closest("[mindar-image-target]");
        this.timer = null;
        this.running = false;

        this.target.addEventListener("targetFound", ()=>this.start());
        this.target.addEventListener("targetLost", ()=>this.reset());
        this.reset();
      },
      reset(){
        this.running = false;
        clearTimeout(this.timer);
        this.layers.forEach(l=>l.setAttribute("value",""));
        this.el.setAttribute("scale","0.001 0.001 0.001");
      },
      start(){
        if(this.running) return;
        this.running = true;

        playAudio(this.data.audio);

        this.el.setAttribute("animation__pop", {
          property:"scale", to:"1 1 1", dur:400, easing:"easeOutCubic"
        });

        const text = this.data.text || "";
        const step = Math.max(15, Math.floor(this.data.duration / Math.max(1, text.length)));
        let i = 0;

        const loop = ()=>{
          if(!this.running) return;
          this.layers.forEach(l=>l.setAttribute("value", text.slice(0,i)));
          i++;
          if(i <= text.length) this.timer = setTimeout(loop, step);
        };
        loop();
      }
    });

    /* ================= MODEL: always small->big ================= */
    AFRAME.registerComponent("reveal-model", {
      schema: {
        duration:{type:"number",default:3000},
        audio:{type:"selector"},
        startScale:{type:"vec3"},
        finalScale:{type:"vec3"},
        startPos:{type:"vec3"},
        finalPos:{type:"vec3"}
      },
      init(){
        this.target = this.el.closest("[mindar-image-target]");
        this.running = false;

        this._hardReset();
        this.target.addEventListener("targetLost", ()=>this._hardReset());
        this.target.addEventListener("targetFound", ()=>this.start());
      },
      _hardReset(){
        this.running = false;

        this.el.removeAttribute("animation__scale");
        this.el.removeAttribute("animation__pos");

        this.el.setAttribute("scale", `${this.data.startScale.x} ${this.data.startScale.y} ${this.data.startScale.z}`);
        this.el.setAttribute("position", `${this.data.startPos.x} ${this.data.startPos.y} ${this.data.startPos.z}`);

        if(this.el.object3D){
          this.el.object3D.scale.set(this.data.startScale.x, this.data.startScale.y, this.data.startScale.z);
          this.el.object3D.position.set(this.data.startPos.x, this.data.startPos.y, this.data.startPos.z);
        }
      },
      start(){
        if(this.running) return;
        this.running = true;

        this._hardReset();
        playAudio(this.data.audio);

        // đợi 2 frame để chắc chắn MindAR đã update visibility
        requestAnimationFrame(()=>requestAnimationFrame(()=>{
          this.el.setAttribute("animation__scale", {
            property:"scale",
            to:`${this.data.finalScale.x} ${this.data.finalScale.y} ${this.data.finalScale.z}`,
            dur:this.data.duration,
            easing:"easeOutCubic"
          });
          this.el.setAttribute("animation__pos", {
            property:"position",
            to:`${this.data.finalPos.x} ${this.data.finalPos.y} ${this.data.finalPos.z}`,
            dur:this.data.duration,
            easing:"easeOutCubic"
          });
        }));
      }
    });

    /* ================= SPIN ================= */
    AFRAME.registerComponent("slow-spin", {
      init(){
        this.el.setAttribute("animation__spin", {
          property:"rotation", to:"0 360 0", loop:true, dur:14000, easing:"linear"
        });
      }
    });

    /* ================= TRANSPARENT MODEL ================= */
    AFRAME.registerComponent("transparent-model", {
      schema:{ opacity:{type:"number",default:0.6} },
      init(){
        this.el.addEventListener("model-loaded", ()=>{
          const op = this.data.opacity;
          this.el.object3D.traverse(n=>{
            if(n.material){
              const mats = Array.isArray(n.material) ? n.material : [n.material];
              mats.forEach(m=>{
                m.transparent = true;
                m.opacity = op;
                m.depthWrite = false;
                m.needsUpdate = true;
              });
            }
          });
        });
      }
    });

    /* ================= VIDEO: play on found, pause+rewind on lost ================= */
    AFRAME.registerComponent("video-on-target", {
      schema: { video: { type: "selector" } },
      init(){
        this.target = this.el.closest("[mindar-image-target]");
        this.video = this.data.video;
        if(!this.video) return;

        // không tự chạy trước
        try { this.video.pause(); this.video.currentTime = 0; } catch(e){}

        this.target.addEventListener("targetFound", ()=>this.play());
        this.target.addEventListener("targetLost", ()=>this.stop());
      },
      play(){
        if(!this.video) return;
        try{
          const p = this.video.play();
          if(p && p.catch) p.catch(()=>{});
        }catch(e){}
      },
      stop(){
        if(!this.video) return;
        try{
          this.video.pause();
          this.video.currentTime = 0;
        }catch(e){}
      }
    });
  </script>
</body>
</html>
